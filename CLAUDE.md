# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Streamlit-based web application for a random prediction game where players try to predict random numbers generated by Random.org's true random number API. Players compete on a leaderboard and can view detailed analytics about their performance and global patterns.

### Core Architecture

- **Frontend**: Single-page Streamlit application (`streamlit_app.py`)
- **Database**: Supabase (PostgreSQL) with two main tables:
  - `leaderboard`: Stores user best scores and game counts
  - `game_runs`: Stores individual game data for analytics
- **External API**: Random.org JSON-RPC API for true random number generation
- **Analytics Engine**: Comprehensive pattern analysis and user statistics (`analytics.py`)

### Key Components

1. **Main Application** (`streamlit_app.py`):
   - Multi-phase game flow: input → user details → results
   - Tab-based interface: Game, Global Analytics, User Analytics
   - Session state management for game progression
   - Cached database operations for performance

2. **API Client** (`api_client.py`):
   - Random.org API integration using JSON-RPC 4.0
   - Error handling for network and API failures
   - Configurable number generation parameters

3. **Analytics System** (`analytics.py`):
   - Global pattern analysis (human vs random number distributions)
   - User-specific performance tracking
   - Advanced statistical insights (prime numbers, even/odd bias, pattern detection)
   - Interactive visualizations with Plotly

4. **Database Schema**:
   - Primary schema in `database_setup.sql`
   - Analytics extensions in `database_analytics_schema.sql`
   - RLS policies for security

## Development Commands

### Setup and Installation
```bash
# Create virtual environment
python3 -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt
```

### Running the Application
```bash
# Start the Streamlit app
streamlit run streamlit_app.py
```

### Testing and Validation
```bash
# Test database connection
python test_db_setup.py

# Test Random.org API integration
python api_client.py

# Test analytics setup
python test_analytics_setup.py

# Create test data for development
python create_test_data.py

# Clean test data
python cleanup_test_data.py
```

## Environment Configuration

Required environment variables (create `.env` file):
```env
# Random.org API
RANDOM_API_KEY=your_random_org_api_key
RANDOM_API_KEY_HASHED=your_hashed_api_key

# Supabase Configuration
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_SECRET_KEY=your_supabase_secret_key
SUPABASE_PUBLISHABLE_KEY=your_supabase_publishable_key
SUPABASE_PROJECT_ID=your_project_id
```

## Database Setup Process

1. Execute `database_setup.sql` in Supabase SQL Editor (creates leaderboard table)
2. Execute `database_analytics_schema.sql` (creates game_runs table and analytics views)
3. Run `python test_db_setup.py` to verify connection

## Key Data Structures

### Game Flow State Management
- `game_state`: 'input' → 'user_details' → 'results'
- Session state variables: `user_numbers`, `random_numbers`, `score`, `user_name`, `user_email`

### Analytics Data Processing
- Number frequency analysis using client-side processing
- Pattern detection for primes, even/odd, repeating digits, multiples
- Performance caching with `@st.cache_data(ttl=300)`

## Architecture Notes

### Performance Optimizations
- Streamlit caching for database queries and resource initialization
- Client-side number frequency processing to reduce database load
- Indexed database queries for leaderboard and analytics

### Security Considerations
- Row Level Security (RLS) enabled on all tables
- Email normalization (lowercase) to prevent duplicates
- Environment variable management for API keys
- No sensitive data in client-side code

### Analytics Insights Engine
The analytics system provides several layers of analysis:
- **Global Patterns**: Human prediction biases vs true randomness
- **Statistical Analysis**: Prime numbers, even/odd distribution, special patterns
- **Performance Correlation**: How biases affect success rates
- **User Behavior**: Individual prediction patterns and progression

### Error Handling Patterns
- Graceful API failures with user-friendly messages
- Database connection error recovery
- Form validation with clear feedback
- Network timeout handling for Random.org API

## Development Tips

- Use `st.rerun()` after session state changes to refresh UI
- Test with both valid and invalid API keys
- Verify database policies allow intended operations
- Analytics queries can be heavy - ensure proper caching
- The game logic prevents duplicate number bias in scoring calculations